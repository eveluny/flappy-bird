import processing.sound.*;

PVector bird;
float birdVelocity = 0;
float gravity = 0.6;
float flapPower = -10;
float birdAngle = 0;

float pipeX;
float pipeWidth = 60;
float pipeGap = 150;
float pipeSpeed;

float topPipeHeight;
float pipeYOffset = 0;

int score = 0;
int pipesPassed = 0;
int bananasCollected = 0;

String gameState = "menu"; // "menu", "play", "gameOver", "tutorial"

PImage monkeyImage;
PImage bananaImage;

ArrayList<PVector> bananas = new ArrayList<PVector>();
ArrayList<PVector> clouds = new ArrayList<PVector>();
ArrayList<Float> treeXPositions = new ArrayList<Float>();
ArrayList<PVector> floatingBananas = new ArrayList<PVector>();
ArrayList<PVector> floatingMonkeys = new ArrayList<PVector>();
ArrayList<PVector> gameOverBananas = new ArrayList<PVector>();

SoundFile bananaSound;
SoundFile backgroundMusic;
SoundFile gameOverSound;
SoundFile impactSound;
SoundFile tutorialSound;

boolean playedGameOverSound = false;
boolean playedImpactSound = false;
boolean playedTutorialSound = false;

void setup() {
  size(600, 400);
  textAlign(CENTER, CENTER);
  textSize(32);

  bananaSound = new SoundFile(this, "gamesound.wav");
  backgroundMusic = new SoundFile(this, "backgroundmusic.wav");
  gameOverSound = new SoundFile(this, "gameoversound.wav");
  impactSound = new SoundFile(this, "impact.wav");
  impactSound.amp(2.0);
  tutorialSound = new SoundFile(this, "tutorialsound.wav");

  backgroundMusic.loop();

  monkeyImage = loadImage("monkey.png");
  bananaImage = loadImage("banana.png");

  // Initialize clouds
  for (int i = 0; i < 5; i++) {
    clouds.add(new PVector(random(width), random(30, 120)));
  }

  // Initialize tree X positions for swaying trees in menu
  for (int i = 0; i < 6; i++) {
    treeXPositions.add(i * 100.0);
  }

  // Initialize floating bananas for tutorial background (spread wider)
  for (int i = 0; i < 7; i++) {
    float x = random(width * 1.5);
    float y = random(80, height - 80);
    floatingBananas.add(new PVector(x, y));
  }

  // Initialize floating monkeys for tutorial background (spread wider)
  for (int i = 0; i < 4; i++) {
    float x = random(width * 1.5);
    float y = random(100, height - 150);
    floatingMonkeys.add(new PVector(x, y));
  }

  // Initialize floating bananas for game over screen
  for (int i = 0; i < 10; i++) {
    gameOverBananas.add(new PVector(random(width), random(50, height - 50)));
  }

  resetGame();
}

void draw() {
  background(135, 206, 250);
  drawClouds();

  if (gameState.equals("menu") || gameState.equals("play")) {
    if (!backgroundMusic.isPlaying()) backgroundMusic.loop();
    if (tutorialSound.isPlaying()) tutorialSound.stop();
    playedGameOverSound = false;
    playedImpactSound = false;
    playedTutorialSound = false;
  } else if (gameState.equals("tutorial")) {
    if (backgroundMusic.isPlaying()) backgroundMusic.stop();
    if (!playedTutorialSound) {
      tutorialSound.play();
      playedTutorialSound = true;
    }
  } else {
    if (backgroundMusic.isPlaying()) backgroundMusic.stop();
    if (tutorialSound.isPlaying()) tutorialSound.stop();
  }

  if (gameState.equals("gameOver") && !playedGameOverSound) {
    gameOverSound.play();
    playedGameOverSound = true;
  }

  if (gameState.equals("menu")) {
    drawSwayingTrees();
    showMenu();
  } else if (gameState.equals("play")) {
    runGame();
  } else if (gameState.equals("gameOver")) {
    drawFloatingGameOverBananas();
    showGameOver();
  } else if (gameState.equals("tutorial")) {
    showTutorial();
  }
}

void drawClouds() {
  fill(255, 240);
  noStroke();
  for (PVector c : clouds) {
    ellipse(c.x, c.y, 60, 40);
    ellipse(c.x + 20, c.y + 10, 50, 30);
    ellipse(c.x - 20, c.y + 10, 50, 30);
    c.x -= 0.4;
    if (c.x < -60) {
      c.x = width + random(50);
      c.y = random(30, 120);
    }
  }
}

void drawSwayingTrees() {
  for (int i = 0; i < treeXPositions.size(); i++) {
    float baseX = treeXPositions.get(i);
    float sway = sin(frameCount * 0.05 + i) * 5;

    float trunkHeight = 60;
    float treeBaseY = height - trunkHeight;

    fill(139, 69, 19);
    rect(baseX + sway, treeBaseY, 10, trunkHeight);

    fill(34, 139, 34);
    ellipse(baseX + sway + 5, treeBaseY - 20, 40, 40);
  }
}

void showMenu() {
  fill(0);
  textSize(32);
  textAlign(CENTER, CENTER);

  imageMode(CENTER);
  image(monkeyImage, width / 2 - 120, height / 2 - 40, 40, 40);
  text("Manic Monkey", width / 2 + 20, height / 2 - 40);

  textSize(24);
  text("Press SPACE to Start", width / 2, height / 2 + 10);
  text("Press T for Tutorial", width / 2, height / 2 + 40);
  text("Press Q to Quit", width / 2, height / 2 + 70);
}

void showTutorial() {
  background(255);
  drawClouds();
  drawFloatingBananas();
  drawFloatingMonkeys();

  fill(0);
  textAlign(CENTER, CENTER);
  textSize(22);
  text("How to Play:", width / 2, 50);

  textSize(18);
  text("Click or Press SPACE/W to Flap", width / 2, 120);
  text("Collect Bananas for Points", width / 2, 160);
  text("Avoid the Pipes", width / 2, 200);
  text("Hitting a Pipe or the Ground Ends the Game", width / 2, 240);

  textSize(16);
  text("Press M to return to the Menu", width / 2, height - 40);
}

void drawFloatingBananas() {
  for (PVector b : floatingBananas) {
    float offsetY = sin(frameCount * 0.05 + b.x) * 5;
    image(bananaImage, b.x, b.y + offsetY, 40, 40);
    b.x += 0.6;

    if (b.x > width + 40) {
      b.x = -random(60, 100);
      b.y = random(80, height - 80);
    }
  }
}

void drawFloatingMonkeys() {
  for (PVector m : floatingMonkeys) {
    float offsetY = sin(frameCount * 0.04 + m.x) * 6;
    image(monkeyImage, m.x, m.y + offsetY, 50, 50);
    m.x += 0.4;

    if (m.x > width + 50) {
      m.x = -random(60, 120);
      m.y = random(100, height - 150);
    }
  }
}

void drawFloatingGameOverBananas() {
  for (PVector b : gameOverBananas) {
    float offsetY = sin(frameCount * 0.03 + b.x) * 7;
    image(bananaImage, b.x, b.y + offsetY, 50, 50);
    b.x += 0.5;

    if (b.x > width + 50) {
      b.x = -random(60, 150);
      b.y = random(50, height - 50);
    }
  }
}

void runGame() {
  pipeSpeed = 3 + (score / 3);

  birdVelocity += gravity;
  bird.y += birdVelocity;

  if (birdVelocity < 0) {
    birdAngle = radians(-20);
  } else {
    birdAngle = constrain(birdAngle + radians(2), radians(-20), radians(90));
  }

  pushMatrix();
  translate(bird.x, bird.y);
  rotate(birdAngle);
  imageMode(CENTER);
  image(monkeyImage, 0, 0, 60, 60);
  popMatrix();

  pipeX -= pipeSpeed;
  pipeYOffset = sin(frameCount * 0.03) * 20;

  if (pipeX < -pipeWidth) {
    pipeX = width;
    topPipeHeight = random(50, height - pipeGap - 50);
    score += 1;
    pipesPassed++;

    int bananasToSpawn = 1 + pipesPassed / 2;

    for (int i = 0; i < bananasToSpawn; i++) {
      float bananaY = random(topPipeHeight + 50, topPipeHeight + pipeGap - 50);
      float offsetX = i * 30;
      bananas.add(new PVector(width + offsetX, bananaY));
    }
  }

  fill(0, 200, 0);
  rect(pipeX, pipeYOffset, pipeWidth, topPipeHeight);
  rect(pipeX, topPipeHeight + pipeGap + pipeYOffset, pipeWidth, height);

  for (int i = bananas.size() - 1; i >= 0; i--) {
    PVector b = bananas.get(i);
    b.x -= pipeSpeed;
    image(bananaImage, b.x, b.y, 80, 80);
    if (dist(bird.x, bird.y, b.x, b.y) < 20) {
      score += 2;
      bananasCollected++;
      bananas.remove(i);
      bananaSound.play();
    }
  }

  boolean hit = bird.y > height || bird.y < 0 ||
    (bird.x + 16 > pipeX && bird.x - 16 < pipeX + pipeWidth &&
    (bird.y - 16 < topPipeHeight + pipeYOffset ||
     bird.y + 16 > topPipeHeight + pipeGap + pipeYOffset));

  if (hit) {
    gameState = "gameOver";
    if (!playedImpactSound) {
      impactSound.play();
      playedImpactSound = true;
    }
  }

  fill(255);
  text("Score: " + score + "   Bananas: " + bananasCollected, width / 2, 30);
}

void showGameOver() {
  drawFloatingGameOverBananas();

  fill(0);
  textSize(48);
  text("Game Over!", width / 2, height / 2 - 60);

  textSize(32);
  text("Final Score: " + score, width / 2, height / 2);
  text("Bananas Collected: " + bananasCollected, width / 2, height / 2 + 40);

  textSize(24);
  text("SPACE: Restart | R: Main Menu | Q: Quit", width / 2, height / 2 + 90);
}

void keyPressed() {
  if (gameState.equals("menu")) {
    if (key == ' ' || key == 'w') {
      gameState = "play";
    } else if (key == 'q' || key == 'Q') {
      exit();
    } else if (key == 't' || key == 'T') {
      gameState = "tutorial";
    }
  } else if (gameState.equals("play")) {
    if (key == ' ' || key == 'w') {
      birdVelocity = flapPower;
      birdAngle = radians(-30);
    }
  } else if (gameState.equals("gameOver")) {
    if (key == ' ') {
      resetGame();
      gameState = "play";
    } else if (key == 'r' || key == 'R') {
      gameState = "menu";
    } else if (key == 'q' || key == 'Q') {
      exit();
    }
  } else if (gameState.equals("tutorial")) {
    if (key == 'm' || key == 'M') {
      gameState = "menu";
    }
  }
}

void resetGame() {
  bird = new PVector(150, height / 2);
  birdVelocity = 0;
  birdAngle = 0;
  pipeX = width;
  topPipeHeight = random(50, height - pipeGap - 50);
  bananas.clear();
  score = 0;
  pipesPassed = 0;
  bananasCollected = 0;
  playedGameOverSound = false;
  playedImpactSound = false;
  playedTutorialSound = false;

  // Reset game over bananas positions
  for (int i = 0; i < gameOverBananas.size(); i++) {
    gameOverBananas.get(i).x = random(width);
    gameOverBananas.get(i).y = random(50, height - 50);
  }

  // Reset floating monkeys position (wider spread)
  for (int i = 0; i < floatingMonkeys.size(); i++) {
    floatingMonkeys.get(i).x = random(width * 1.5);
    floatingMonkeys.get(i).y = random(100, height - 150);
  }

  // Reset floating bananas position (wider spread)
  for (int i = 0; i < floatingBananas.size(); i++) {
    floatingBananas.get(i).x = random(width * 1.5);
    floatingBananas.get(i).y = random(80, height - 80);
  }
}
